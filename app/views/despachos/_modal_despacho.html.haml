#modaldesp.modal.fade{"aria-labelledby" => "nuevoLabel", :role => "dialog", :tabindex => "-1"}
  .modal-dialog.modal-xs{:role => "document"}
    .modal-content
      .modal-header
        %button.close{"aria-label" => "Close", "data-dismiss" => "modal", :type => "button"}
          %span{"aria-hidden" => "true"} &times;
        %h4#nuevoLabel.modal-title= t(".#{actionvar}_despacho") + " #{@despacho.id}"
      = form_for @despacho, url: { action: actionvar } do |f|
        = hidden_field_tag :exps_ids
        .modal-body
          .row
            .col-md-6#first-column
              .input-group
                = f.label :nro_fojas, { class: "input-group-addon", id: "basic-addon1"}
                = f.text_field :nro_fojas, { class: "form-control", "aria-describedby": "basic-addon1", :placeholder => t('.fojas'), type: :number }
              .input-group
                = f.label :fecha, { class: "input-group-addon", id: "basic-addon2"}
                = f.text_field :fecha, {class: "form-control", "aria-describedby" => "basic-addon2", type: :date}
              .input-group
                = f.label :expedientes, { class: "input-group-addon", id: "basic-addon3" }
                = f.text_field :expedientes, { class: "form-control", "aria-describedby": "basic-addon3", id: "exped_token",
                                               type: "text", data: { load: prepopulate_exps(@despacho) }}
              .input-group
                = f.label :comisions, t('.comisions'), { class: "input-group-addon", id: "basic-addon4" }
                = f.select(:comisions, options_for_select(get_options_comisions()), {}, {:multiple => "multiple", :style => "width:100%", :id => "despacho_comisions", data: { load: prepopulate_comisions(@despacho) }})
              .input-group
                = f.label :concejals, t('.concejals'), { class: "input-group-addon", id: "basic-addon5" }
                = f.select(:concejals, options_for_select(get_options_concejals()), {}, {:multiple => "multiple", :style => "width:100%", :id => "despacho_concejals", data: { load: prepopulate_concejals(@despacho) }})
              .input-group
                = f.label t('.observations'), { class: "input-group-addon", id: "basic-addon7"}
                = f.text_area :observaciones, {class: "form-control", "aria-describedby" => "basic-addon7", :placeholder => t('.observations'), type: :text }
            .col-md-8
              #second-column
        .modal-footer
          = f.submit "Guardar", { class: "btn btn-primary modal-submit" }

:javascript
  wi = $(window).width()-20;
  margin = 10;
  $("#despacho .modal-xs").css('width', wi);
  $("#despacho .modal-xs").css('margin-left', margin);

  //var data = [{ id: 0, text: 'enhancement' }, { id: 1, text: 'bug' }, { id: 2, text: 'duplicate' }, { id: 3, text: 'invalid' }, { id: 4, text: 'wontfix' }];

  function format_comisions(style) {
    var originalOption = $(style.element);
    return "<div class='comision-token' data-id=" + style.id + ">" + style.text + "</div>";
  }

  function format_concejals(style) {
    var originalOption = $(style.element);
    return "<div class='concejal-token' data-id=" + style.id + ">" + style.text + "</div>";
  }

  $("#despacho_comisions").select2({
    placeholder: "Seleccione las comisiones",
    allowClear: true,
    closeOnSelect:false,
    theme: 'bootstrap',
    formatSelection: format_comisions
  });

  $("#despacho_concejals").select2({
    placeholder: "Seleccione los concejales",
    allowClear: true,
    closeOnSelect:false,
    theme: 'bootstrap',
    formatSelection: format_concejals
  });

  $('#despacho #exped_token').tokenInput('/despachos/search_exp', {
    preventDuplicates: true,
    propertyToSearch: 'indice',
    theme: 'bootstrap',
    zindex: 1050,
    hintText: "#{t 'tokeninput.hint.enter_exp'}",
    resultsFormatter: function(exp) {
      return '<li><p style= \'color: black\'> Exp: ' + exp.indice + '</p></li>';
    },
    tokenFormatter: function(exp) {
      return "<li><p class='exps-token' data-id='" + exp.id + "'>" + " Exp: " + exp.indice + "</p></li>";
    },
    allowTabOut: true,
    placeholder: "#{ I18n.t('tokeninput.placeholder.exp_example') }"
  });

  $(document).on('click', '#despacho .modal-submit', function(event) {
    event.preventDefault();

    //add exp ids to form
    var expsIds = []
    $("#despacho .exps-token").each(function(key, value) {
      expsIds.push($(value).data("id"))
    });

    $("#despacho #exps_ids").val(expsIds);
    $("#despacho #new_despacho, [id^='edit_despacho']").submit();
  });

  $('#modaldesp').on('hidden.bs.modal', function () {
    $(document).keydown(function(event) {
      var currentRow, rowpos, table;
      table = $('#despacho-table').dataTable();
      currentRow = $('#despacho-table tbody tr.info').get(0);
      switch (event.keyCode) {
        case 40:
          if ($(currentRow).next().length !== 0) {
            $(currentRow).next().addClass('info');
            $(currentRow).removeClass('info');
          }
          break;
        case 38:
          if ($(currentRow).prev().length !== 0) {
            $(currentRow).prev().addClass('info');
            $(currentRow).removeClass('info');
          }
          break;
        case 37:
          table.fnPageChange('previous');
          break;
        case 39:
          table.fnPageChange('next');
          break;
        case 13:
          $('#despacho tr.info').find('td:eq(0) a').get(0).click();
      }
      rowpos = $('#despacho tr.info').position();
      $(document).scrollTop(rowpos.top - 45);
    });
    $.ctrl('C', function() {
      $('#despacho #btn-new').click();
    });

    $.ctrl('E', function() {
      $('#despacho table tbody').find('.info').find('.linktoedit').click();
    });

    $.ctrl('D', function() {
      $('#despacho table tbody').find('.info').find('.remove-tr').click();
    });

    $('#despacho div.dataTables_filter input').focus();
  });


