#modalcond.modal.fade{"aria-labelledby" => "nuevoLabel", :role => "dialog", :tabindex => "-1"}
  .modal-dialog.modal-xs{:role => "document"}
    .modal-content
      .modal-header
        %button.close{"aria-label" => "Close", "data-dismiss" => "modal", :type => "button"}
          %span{"aria-hidden" => "true"} &times;
        %h4#nuevoLabel.modal-title= t('.new_condonacion')
      = form_for @condonacion, url: { action: actionvar } do |f|
        = hidden_field_tag :iniciadores
        .modal-body
          .row
            .col-md-6#first-column
              .input-group
                = f.label t('.iniciadores'), { class: "input-group-addon", id: "basic-addon08" }
                = text_field_tag nil, nil, {:multiple => "multiple", :style => "width:100%", :id => "condonacion_iniciadores", data: { load: prepopulate_iniciadores(@condonacion) }}
              .input-group
                = f.label :nro_fojas, { class: "input-group-addon", id: "basic-addon8"}
                = f.text_field :nro_fojas, { class: "form-control", "aria-describedby": "basic-addon8", :placeholder => t('.fojas'), type: :number }
              .input-group
                = f.label t('.asunto_label'), { class: "input-group-addon", id: "basic-addon9"}
                = f.text_area :asunto, {class: "form-control", "aria-describedby" => "basic-addon9", :placeholder => t('.asunto'), type: :text}          
              .input-group
                = f.label t('.observations'), { class: "input-group-addon", id: "basic-addon10"}
                = f.text_area :observaciones, {class: "form-control", "aria-describedby" => "basic-addon10", :placeholder => t('.observations'), type: :text }
            .col-md-6
              #second-column
                .input-group
                  = label_tag nil, t('.iniciador'), { class: "input-group-addon", id: "basic-addon0"}
                  .input-group
                    = label_tag nil, "Tipo", { class: "input-group-addon", id: "basic-addon01"}  
                    #refer_type= select_tag 'iniciador[tipo]', options_for_select(tipo_iniciador), { class: "form-control", "aria-describedby": "basic-addon01"}  
                  .input-group
                    = label_tag nil, "Nombre", { class: "input-group-addon", id: "basic-addon1"}
                    = text_field_tag 'iniciador[nombre]', nil ,{ class: "form-control", "aria-describedby": "basic-addon1", :placeholder => t('.nombre'), type: :text }
                  .input-group
                    = label_tag nil, "Apellido", { class: "input-group-addon", id: "basic-addon2"}
                    = text_field_tag 'iniciador[apellido]', nil ,{ class: "form-control", "aria-describedby": "basic-addon2", :placeholder => t('.apellido'), type: :text }
                  .input-group
                    = label_tag nil, "DNI", { class: "input-group-addon", id: "basic-addon3"}
                    = text_field_tag 'iniciador[doc]', nil ,{ class: "form-control", "aria-describedby": "basic-addon3", :placeholder => t('.doc'), type: :text }
                  .input-group
                    = label_tag nil, "Teléfono", { class: "input-group-addon", id: "basic-addon4"}
                    = text_field_tag 'iniciador[tel]', nil ,{ class: "form-control", "aria-describedby": "basic-addon4", :placeholder => t('.tel'), type: :text }
                  .input-group
                    = label_tag nil, "Email", { class: "input-group-addon", id: "basic-addon5"}
                    = text_field_tag 'iniciador[email]', nil ,{ class: "form-control", "aria-describedby": "basic-addon5", :placeholder => t('.email'), type: :text }
                  .input-group
                    = label_tag nil, "Domicilio", { class: "input-group-addon", id: "basic-addon6"}
                    = text_field_tag 'iniciador[domicilio]', nil ,{ class: "form-control", "aria-describedby": "basic-addon6", :placeholder => t('.domicilio'), type: :text }
                  .input-group
                    = label_tag nil, "CUIT/CUIL", { class: "input-group-addon", id: "basic-addon7"}
                    = text_field_tag 'iniciador[cuit]', nil ,{ class: "form-control", "aria-describedby": "basic-addon7", :placeholder => t('.cuit'), type: :number }
                .parent-group-btn.btn.btn-xs#add_iniciador
                  %button.btn.parent-group-btn#btn_add_iniciador
                    %span
                      %i.fa.fa-check-circle.fa-1x= " Guardar Iniciador"
                .parent-group-btn.btn.btn-xs#edit_iniciador
                  %button.btn.parent-group-btn#btn_edit_iniciador
                    %span
                      %i.fa.fa-pencil-square.fa-1x= " Editar Iniciador"   
        .modal-footer
          = f.submit "Guardar Condonación", {class: "btn btn-primary modal-submit", id: "btn-submit-condonacion"}

:javascript
  wi = $(window).width()-20;
  margin = 10;
  $("#condonacion .modal-xs").css('width', wi);
  $("#condonacion .modal-xs").css('margin-left', margin);
  
  function format_iniciadores(style) {
    var originalOption = $(style.element);
    var iniciador = "";
    iniciador = style.apellido + ', ' + style.nombre;
    if (style.type == "Juridica" || style.type == "Fisica" || style.type == "Concejal" ) {
      return "<div class='iniciador-token' data-id='" + style.id + "' data-nombre='"+ style.nombre + "' data-apellido='"+ style.apellido +  "' data-doc='"+ style.nro_doc +  "' data-telefono='"+ style.telefono +  "' data-email='"+ style.email + "' data-domicilio='"+ style.domicilio + "' data-cuit='"+ style.cuit + "' data-type='"+ style.type + "'>" + iniciador + "</div>";
    }else{
      //Casos para comisiones y bloques, etc
      if (style.type == "Comision" || style.type == "Bloque"){
        iniciador = style.denominacion;
        return "<div class='iniciador-token' data-id='" + style.id + "' data-type='"+ style.type + "'>" + iniciador + "</div>";  
      }else{
        //otros casos
      }
    }
  }

  function format_result_iniciadores(style) {
    var originalOption = $(style.element);
    if (style.type == "Juridica" || style.type == "Fisica" || style.type == "Concejal" ) {
      return "<div>" + style.type + " " + style.apellido + ', ' + style.nombre + "</div>";
    }else{
      //caso de comisiones y bloques
      if (style.type == "Comision" || style.type == "Bloque"){
        return "<div>" + style.type + " " + style.denominacion + "</div>";
      }else{
        //caso de cualquier otro type
        return "<div>" + style.apellido + "</div>";
      }  
    }  
  }

  $("#condonacion_iniciadores").select2({
    placeholder: "Buscar Iniciadores",
    allowClear: true,
    theme: 'bootstrap',
    formatSelection: format_iniciadores,
    formatResult: format_result_iniciadores,
    multiple: true,
    ajax: {
      url: "/condonacions/get_iniciador",
      dataType: 'json',
      delay: 250,
      data: function (params) {
        return {
          q: params
        };
      },
      results: function (data, page) {
        // parse the results into the format expected by Select2.
        // since we are using custom formatting functions we do not need to
        // alter the remote JSON data
        return {
          results: data
        };
      },
      cache: true
    }
  }).on("select2-selecting", function(e) {
    // token selected
    var data = e.object
    if (data.apellido == 'Agregar Nuevo'){
      e.preventDefault();
      $('#condonacion #iniciador_nombre').val('');
      $('#condonacion #iniciador_apellido').val('');
      $('#condonacion #iniciador_doc').val('');
      $('#condonacion #iniciador_tel').val('');
      $('#condonacion #iniciador_email').val('');
      $('#condonacion #iniciador_domicilio').val('');
      $('#condonacion #iniciador_cuit').val('');
      $("#condonacion_iniciadores").select2("close");
      $('#condonacion #iniciador_nombre').focus();
    }else{
      if(data.type == 'Fisica' || data.type == 'Juridica'){
        $('#condonacion #edit_iniciador').data('id',data.id);
        $('#condonacion #edit_iniciador').css('display','block');
        $('#condonacion #add_iniciador').css('display','none');
        $('#condonacion #iniciador_tipo').val(data.type).removeAttr('disabled');
        $('#condonacion #iniciador_nombre').val(data.nombre).removeAttr('disabled');
        $('#condonacion #iniciador_apellido').val(data.apellido).removeAttr('disabled');
        $('#condonacion #iniciador_doc').val(data.nro_doc).removeAttr('disabled');
        $('#condonacion #iniciador_tel').val(data.telefono).removeAttr('disabled');
        $('#condonacion #iniciador_email').val(data.email).removeAttr('disabled');
        $('#condonacion #iniciador_domicilio').val(data.domicilio).removeAttr('disabled');
        $('#condonacion #iniciador_cuit').val(data.cuit).removeAttr('disabled');
      }else{
        $('#condonacion #edit_iniciador').css('display','none');
        $('#condonacion #add_iniciador').css('display','none');
        $('#condonacion #iniciador_tipo').val('').attr('disabled','disabled');
        $('#condonacion #iniciador_nombre').val('').attr('disabled','disabled');
        $('#condonacion #iniciador_apellido').val('').attr('disabled','disabled');
        $('#condonacion #iniciador_doc').val('').attr('disabled','disabled');
        $('#condonacion #iniciador_tel').val('').attr('disabled','disabled');
        $('#condonacion #iniciador_email').val('').attr('disabled','disabled');
        $('#condonacion #iniciador_domicilio').val('').attr('disabled','disabled');
        $('#condonacion #iniciador_cuit').val('').attr('disabled','disabled');
      }
    }    
  });

  $('#condonacion_iniciadores').on('choice-selected', function(e, choice) {
    // token selected
    var data = $(choice).data('select2-data');
    if(data.type == 'Fisica' || data.type == 'Juridica'){
      $('#condonacion #edit_iniciador').data('id',data.id);
      $('#condonacion #edit_iniciador').css('display','block');
      $('#condonacion #add_iniciador').css('display','none');
      $('#condonacion #iniciador_tipo').val(data.type).removeAttr('disabled');
      $('#condonacion #iniciador_nombre').val(data.nombre).removeAttr('disabled');
      $('#condonacion #iniciador_apellido').val(data.apellido).removeAttr('disabled');
      $('#condonacion #iniciador_doc').val(data.nro_doc).removeAttr('disabled');
      $('#condonacion #iniciador_tel').val(data.telefono).removeAttr('disabled');
      $('#condonacion #iniciador_email').val(data.email).removeAttr('disabled');
      $('#condonacion #iniciador_domicilio').val(data.domicilio).removeAttr('disabled');
      $('#condonacion #iniciador_cuit').val(data.cuit).removeAttr('disabled');
    }else{
      $('#condonacion #add_iniciador').css('display','none');
      $('#condonacion #edit_iniciador').css('display','none');
      $('#condonacion #iniciador_tipo').val('').attr('disabled','disabled');
      $('#condonacion #iniciador_nombre').val('').attr('disabled','disabled');
      $('#condonacion #iniciador_apellido').val('').attr('disabled','disabled');
      $('#condonacion #iniciador_doc').val('').attr('disabled','disabled');
      $('#condonacion #iniciador_tel').val('').attr('disabled','disabled');
      $('#condonacion #iniciador_email').val('').attr('disabled','disabled');
      $('#condonacion #iniciador_domicilio').val('').attr('disabled','disabled');
      $('#condonacion #iniciador_cuit').val('').attr('disabled','disabled');
    }
  });

  $('.select2-input').on("focus", function(e) {
    // token unselected
    $('#condonacion #edit_iniciador').css('display','none');
    $('#condonacion #add_iniciador').css('display','block');
    $('#condonacion #iniciador_tipo').val('Fisica').removeAttr('disabled');
    $('#condonacion #iniciador_nombre').val('').removeAttr('disabled');
    $('#condonacion #iniciador_apellido').val('').removeAttr('disabled');
    $('#condonacion #iniciador_doc').val('').removeAttr('disabled');
    $('#condonacion #iniciador_tel').val('').removeAttr('disabled');
    $('#condonacion #iniciador_email').val('').removeAttr('disabled');
    $('#condonacion #iniciador_domicilio').val('').removeAttr('disabled');
    $('#condonacion #iniciador_cuit').val('').removeAttr('disabled');
  });

  $('#condonacion_nro_fojas, #condonacion_asunto, #condonacion_observaciones').on("focus", function(e) {
    $('#condonacion #edit_iniciador').css('display','none');
    $('#condonacion #add_iniciador').css('display','none');
    $('#condonacion #iniciador_tipo').val('').attr('disabled','disabled');
    $('#condonacion #iniciador_nombre').val('').attr('disabled','disabled');
    $('#condonacion #iniciador_apellido').val('').attr('disabled','disabled');
    $('#condonacion #iniciador_doc').val('').attr('disabled','disabled');
    $('#condonacion #iniciador_tel').val('').attr('disabled','disabled');
    $('#condonacion #iniciador_email').val('').attr('disabled','disabled');
    $('#condonacion #iniciador_domicilio').val('').attr('disabled','disabled');
    $('#condonacion #iniciador_cuit').val('').attr('disabled','disabled');
  });

  $('#condonacion #edit_iniciador').on('click', function(event) {
    //update inicador Fisico o Juridico
    if (confirm("Desea editar el iniciador seleccionado")) {
      var id = $(this).data('id');
      var iniciador = { persona: { nombre: $('#condonacion #iniciador_nombre').val(),
                apellido: $('#condonacion #iniciador_apellido').val(),
                nro_doc: $('#condonacion #iniciador_doc').val(),
                telefono: $('#condonacion #iniciador_tel').val(),
                email: $('#condonacion #iniciador_email').val(),
                domicilio: $('#condonacion #iniciador_domicilio').val(),
                cuit: $('#condonacion #iniciador_cuit').val() }};
      $.ajax({
        url: "/personas/" + id,
        type: 'PATCH',
        data: iniciador ,
        dataType: 'json',
        success: function(result) {
          var iniciador = result.iniciador
          var ini = {id: iniciador.id, nombre: iniciador.nombre, apellido: iniciador.apellido, nro_doc: iniciador.nro_doc, telefono: iniciador.telefono, email: iniciador.email, domicilio: iniciador.domicilio, cuit: iniciador.cuit, type: iniciador.type}
          var iniciadores = $('#condonacion #condonacion_iniciadores').select2('data');
          iniciadores.unshift(ini);
          $('#condonacion #condonacion_iniciadores').select2('data', iniciadores);
          // Clear fields
          $('#condonacion #iniciador_nombre').val('');
          $('#condonacion #iniciador_apellido').val('');
          $('#condonacion #iniciador_doc').val('');
          $('#condonacion #iniciador_tel').val('');
          $('#condonacion #iniciador_email').val('');
          $('#condonacion #iniciador_domicilio').val('');
          $('#condonacion #iniciador_cuit').val('');
          $('#condonacion #condonacion_nro_fojas').focus();
        },
        error: function () {
            alert("No se pudo actualizar el iniciador");
        }
      });
    }
  });

  $('#condonacion #add_iniciador').on('click', function(event) {
    //create iniciador
    if (confirm("Desea crear el iniciador")) {
      var iniciador = { persona: {  type: $('#condonacion #iniciador_tipo').val(),
                nombre: $('#condonacion #iniciador_nombre').val(),
                apellido: $('#condonacion #iniciador_apellido').val(),
                nro_doc: $('#condonacion #iniciador_doc').val(),
                telefono: $('#condonacion #iniciador_tel').val(),
                email: $('#condonacion #iniciador_email').val(),
                domicilio: $('#condonacion #iniciador_domicilio').val(),
                cuit: $('#condonacion #iniciador_cuit').val() }};
      $.ajax({
        url: "/personas",
        type: 'POST',
        data: iniciador ,
        dataType: 'json',
        success: function(result) {
          var iniciador = result.iniciador
          var ini = {id: iniciador.id, nombre: iniciador.nombre, apellido: iniciador.apellido, nro_doc: iniciador.nro_doc, telefono: iniciador.telefono, email: iniciador.email, domicilio: iniciador.domicilio, cuit: iniciador.cuit, type: iniciador.type}
          var iniciadores = $('#condonacion #condonacion_iniciadores').select2('data');
          iniciadores.push(ini);
          $('#condonacion #condonacion_iniciadores').select2('data', iniciadores);
          // Clear fields
          $('#condonacion #iniciador_nombre').val('');
          $('#condonacion #iniciador_apellido').val('');
          $('#condonacion #iniciador_doc').val('');
          $('#condonacion #iniciador_tel').val('');
          $('#condonacion #iniciador_email').val('');
          $('#condonacion #iniciador_domicilio').val('');
          $('#condonacion #iniciador_cuit').val('');
          $('#condonacion #condonacion_nro_fojas').focus();
        },
        error: function () {
            alert("No se pudo crear el iniciador");
        }
      });
    }
  });

  $('#condonacion .modal-submit').on('click', function(event) {
    event.preventDefault();
    
    var iniciadores = {};
    var index = 0;
    $("#condonacion .iniciador-token").each(function(key, value) {
      iniciadores[index] = {
        id: $(value).data("id"),
        type: $(value).data("type")
      };
      index++;
    });
    
    $("#condonacion #iniciadores").val(JSON.stringify(iniciadores));
    $("#condonacion #new_condonacion, [id^='edit_condonacion']").submit();
  });
  
  $('#modalcond').on('hidden.bs.modal', function () {
    $(document).keydown(function(event) {
      var currentRow, rowpos, table;
      table = $('#condonacion-table').dataTable();
      currentRow = $('#condonacion-table tbody tr.info').get(0);
      switch (event.keyCode) {
        case 40:
          if ($(currentRow).next().length !== 0) {
            $(currentRow).next().addClass('info');
            $(currentRow).removeClass('info');
          }
          break;
        case 38:
          if ($(currentRow).prev().length !== 0) {
            $(currentRow).prev().addClass('info');
            $(currentRow).removeClass('info');
          }
          break;
        case 37:
          table.fnPageChange('previous');
          break;
        case 39:
          table.fnPageChange('next');
          break;
        case 13:
          $('#condonacion tr.info').find('td:eq(0) a').get(0).click();
      }
      rowpos = $('#condonacion tr.info').position();
      $(document).scrollTop(rowpos.top - 45);
    });
    $.ctrl('C', function() {
      $('#condonacion #btn-new').click();
    });

    $.ctrl('E', function() {
      $('#condonacion table tbody').find('.info').find('.linktoedit').click();
    });

    $.ctrl('D', function() {
      $('#condonacion table tbody').find('.info').find('.remove-tr').click();
    });

    $('#condonacion div.dataTables_filter input').focus();
  });