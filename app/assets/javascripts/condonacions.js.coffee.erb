$(document).on 'ready page:load', ->
  $('#condonacion-table').dataTable
    ajaxSource: $('#condonacion-table').data('source')
    fnInitComplete: ->
      $('#condonacion div.dataTables_filter input').focus()
      $('#btn-new').prependTo('#condonacion-table_wrapper .col-sm-6:first')
      return
    fnDrawCallback: ->
      $('#condonacion-table tbody tr:eq(0)').addClass 'info'
      return
    aoColumns: [
      { sortable: false, "width": "10%" , sClass: "center"}
      { sortable: false, "width": "10%" }
      { sortable: false }
      { sortable: false }
      { sortable: false }
      { sortable: false, "width": "14%" }
      { sortable: false, "width": "7%" }
    ]

  $('#condonacion #btn-new').on 'click', ->
    $(document).off 'keydown'
    $.get '/condonacions/new', (data) ->
      $('#condonacion-edit').empty()
      $('#condonacion-edit').append data
      $('#condonacion-edit .modal').modal 'show'
      return

  $(document).on 'click', '#condonacion #btn_add_iniciador', (event) ->
    event.preventDefault()
    return

  $(document).on 'click', '#condonacion #btn_edit_iniciador', (event) ->
    event.preventDefault()
    return

  $(document).on 'click', '#condonacion .linktoedit', ->
    $(document).off 'keydown'
    id = $(this).data 'id'
    $('#condonacion-edit').empty()
    $.get "/condonacions/#{id}/edit", (data) ->
      $('#condonacion-edit').append data
      $('#condonacion-edit .modal').modal 'show'

      ## Preload iniciadores-tokens
      tokenData = $('#condonacion #process_iniciadores').data 'load'
      iniciadores = [];
      $.each tokenData, (index, ini) ->
        if(ini.type == "Fisica" || ini.type == "Juridica" || ini.type == "Concejal")
          iniciadores.push({id: ini.id, nombre: ini.nombre, apellido: ini.apellido, nro_doc: ini.nro_doc, telefono: ini.telefono, email: ini.email, domicilio: ini.domicilio, cuit: ini.cuit, type: ini.type})
        else
          if(ini.type == "ReparticionOficial" || ini.type == "Comision" || ini.type == "Bloque")
            iniciadores.push({id: ini.id, denominacion: ini.denominacion, type: ini.type})
          else
            ## otro caso
        return
      $('#condonacion #process_iniciadores').select2('data', iniciadores)

      return

  ## hotkey create condonacion
  $.ctrl 'C', ->
    $('#condonacion #btn-new').click()
    return

  ## hotkey edit condonacion
  $.ctrl 'E', ->
    $('#condonacion table tbody').find('.info').find('.linktoedit').click()
    return

  $('#condonacion-show #print-condonacion').on 'click', ->
    $('#condonacion-show').print
      globalStyles: true
      mediaPrint: false
      stylesheet: null
      noPrintSelector: '.no-print'
      iframe: true
      append: null
      manuallyCopyFormValues: true
      deferred: $.Deferred()
      timeout: 250

  ## hotkey print condonacion
  $.ctrl 'P', ->
    $('#condonacion-show #print-condonacion').click()
    return

  $('#condonacion-show').on 'ajax:success', '.condonacion-edit', (XHR, data, success) ->
    $('#condonacion-edit').html data
    $('#condonacion-edit .modal').modal 'show'

    ## Preload iniciadores-tokens
    tokenData = $('#condonacion-show #process_iniciadores').data 'load'
    iniciadores = [];
    $.each tokenData, (index, ini) ->
      if(ini.type == "Fisica" || ini.type == "Juridica" || ini.type == "Concejal")
        iniciadores.push({id: ini.id, nombre: ini.nombre, apellido: ini.apellido, nro_doc: ini.nro_doc, telefono: ini.telefono, email: ini.email, domicilio: ini.domicilio, cuit: ini.cuit, type: ini.type})
      else
        if(ini.type == "ReparticionOficial" || ini.type == "Comision" || ini.type == "Bloque")
          iniciadores.push({id: ini.id, denominacion: ini.denominacion, type: ini.type})
        else
          ## otro caso
      return
    $('#condonacion-show #process_iniciadores').select2('data', iniciadores)

    return
