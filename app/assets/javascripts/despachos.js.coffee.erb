$(document).on 'ready page:load', ->
  $('#despacho-table').dataTable
    ajaxSource: $('#despacho-table').data('source')
    fnInitComplete: ->
      $('#despacho div.dataTables_filter input').focus()
      $('#despacho div.dataTables_filter input').attr('placeholder', "<%= I18n.t('.datatable.search') %>")
      return
    fnDrawCallback: ->
      $('#despacho-table tbody tr:eq(0)').addClass 'info'
      return
    aoColumns: [
      { sortable: false, "sWidth": "1%" , sClass: "center"}
      { sortable: false }
      { sortable: false }
      { sortable: false }
      { sortable: false }
      { sortable: false }
      { sortable: false, "sWidth": "14%" }
      { sortable: false, "sWidth": "1%" }
    ]

  $(document).on 'click', '#despacho .remove-tr', ->
    id = $(this).data 'remove'
    if confirm('Desea eliminar el Despacho')
      $.ajax
        url: "/despachos/#{id}"
        type: 'DELETE'
        success: (result) ->
          window.location.href = result.url
          return

  $('#despacho #btn-new').on 'click', ->
    $(document).off 'keydown'
    $.get '/despachos/new', (data) ->
      $('#despacho-edit').empty()
      $('#despacho-edit').append data
      $('#despacho-edit .modal').modal 'show'
      return

  $(document).on 'click', '#despacho .linktoedit', ->
    $(document).off 'keydown'
    id = $(this).data 'id'
    $('#despacho-edit').empty()
    $.get "/despachos/#{id}/edit", (data) ->
      $('#despacho-edit').append data
      $('#despacho-edit .modal').modal 'show'

      ## Preload token inputs
      tokenData = $('#despacho #exped_token').data 'load'
      $.each tokenData, (index, exp) ->
        $('#despacho #exped_token').tokenInput 'add', exp
        return

      ## Preload select2 input comisions
      tokenComision = $('#despacho #despacho_comisions').data 'load'
      comisions = [];
      $.each tokenComision, (index, com) ->
        comisions.push({id: com[0].id, text: com[0].denominacion});
        return
      $('#despacho #despacho_comisions').select2('data', comisions);

      ## Preload select2 input concejals
      tokenConcejal = $('#despacho #despacho_concejals').data 'load'
      concejals = [];
      $.each tokenConcejal, (index, con) ->
        concejals.push({id: con[0].id, text: con[0].nombre});
        return
      $('#despacho #despacho_concejals').select2('data', concejals);

      return


  ## hotkey create despacho
  $.ctrl 'C', ->
    $('#despacho #btn-new').click()
    return

  ## hotkey edit despacho
  $.ctrl 'E', ->
    $('#despacho table tbody').find('.info').find('.linktoedit').click()
    return

  ## hotkey delete despacho
  $.ctrl 'D', ->
    $('#despacho table tbody').find('.info').find('.remove-tr').click()
    return
