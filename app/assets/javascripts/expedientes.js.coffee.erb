$(document).on 'ready page:load', ->
  $('#expedientes-table').dataTable
    ajaxSource: $('#expedientes-table').data('source')
    fnInitComplete: ->
      $('#expedientes div.dataTables_filter input').focus()
      $('#btn-new').prependTo('#expedientes-table_wrapper .col-sm-6:first')
      return
    fnDrawCallback: ->
      $('#expedientes-table tbody tr').find('td:eq(1)').each ->
        $(this).text $(this).text().substring(0, 125) + '...'
        return
      $('#expedientes-table tbody tr:eq(0)').addClass 'info'
      return
    aoColumns: [
      { sortable: false, "width": "12%" , sClass: "center"}
      { sortable: false }
      { sortable: false }
      { sortable: false, "width": "14%" }
      { sortable: false, "width": "1%" }
    ]

  $(document).on 'click', '#modal-expediente #add_state', ->
    fecha = $("#modal-expediente #fecha").val()
    estado = $("#modal-expediente #estados option:selected").val()
    estado_text = $("#modal-expediente #estados option:selected").text()
    esp1_text = $("#modal-expediente #esp1 option:selected").text()
    esp2_text = $("#modal-expediente #esp2 option:selected").text()
    row = "<tr class='states-tr' data-id=''" +
    " data-fecha='#{fecha || ''}' data-estado='#{estado || ''}' data-esp1='#{esp1_text || ''}'" +
    " data-esp2='#{esp2_text || ''}'> " +
    "<td> #{estado_text} </td> " +
    "<td> #{esp1_text + " --> " + esp2_text} </td>" +
    "<td> #{fecha} </td>" +
    "<td> <i class='fa fa-times remove-table-row btn btn-xs'></i> </td> </tr>"
    $('#modal-expediente #states-table-column tbody').append(row)
    $('#modal-expediente #fecha').val("")
    $('#modal-expediente #estados').val("0")
    $('#modal-expediente #esp1').empty()
    $('#modal-expediente #esp2').empty()

  $(document).on 'click', '#modal-circuito #add_state', ->
    fecha = $("#modal-circuito #fecha").val()
    estado = $("#modal-circuito #estados option:selected").val()
    estado_text = $("#modal-circuito #estados option:selected").text()
    esp1 = $("#modal-circuito #esp1 option:selected").val()
    esp1_text = $("#modal-circuito #esp1 option:selected").text()
    esp2 = $("#modal-circuito #esp2 option:selected").val()
    esp2_text = $("#modal-circuito #esp2 option:selected").text()
    row = "<tr class='states-tr'" +
    " data-fecha='#{fecha}' data-estado='#{estado}' data-esp1='#{esp1_text}'" +
    " data-esp2='#{esp2_text}'> " +
    "<td> #{estado_text} </td> " +
    "<td> #{esp1_text + " --> " + esp2_text} </td>" +
    "<td> #{fecha} </td>" +
    "<td> <i class='fa fa-times remove-table-row btn btn-xs'></i> </td> </tr>"
    $('#modal-circuito #states-table-column tbody').append(row)
    $('#modal-circuito #fecha').val("")
    $('#modal-circuito #estados').val("0")
    $('#modal-circuito #esp1').empty()
    $('#modal-circuito #esp2').empty()

  $('#expedientes #btn-new').on 'click', ->
    $(document).off 'keydown'
    $.get '/expedientes/new', (data) ->
      $('#expedientes-edit').empty()
      $('#expedientes-edit').append data
      $('#expedientes-edit .modal').modal 'show'
      return

  $(document).on 'click', '#expedientes .linktoedit', ->
    $(document).off 'keydown'
    id = $(this).data 'id'
    $('#expedientes-edit').empty()
    $.get "/expedientes/#{id}/edit", (data) ->
      $('#expedientes-edit').append data
      $('#expedientes-edit .modal').modal 'show'
      return

  $(document).on 'click', '#expedientes .linktoprint', ->
    $('#expedientes #caratula').css('display','block')
    $('#expedientes #caratula #numero-text').append $(this).data('nro')
    $('#expedientes #caratula #iniciador-text').append $(this).data('iniciador')
    $('#expedientes #caratula #asunto-text').append $(this).data('asunto')
    $('#expedientes #caratula #ingreso-text').append $(this).data('anio')
    $('#expedientes #caratula').print
      globalStyles: true
      mediaPrint: false
      stylesheet: null
      noPrintSelector: '.no-print'
      iframe: true
      append: null
      prepend: null
      manuallyCopyFormValues: true
      deferred: $.Deferred()
      timeout: 1000
    $('#expedientes #caratula #ingreso-text').empty()
    $('#expedientes #caratula #numero-text').empty()
    $('#expedientes #caratula #iniciador-text').empty()
    $('#expedientes #caratula #asunto-text').empty()
    $('#expedientes #caratula #ingreso-text').append '<br>'
    $('#expedientes #caratula #ingreso-text').append '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
    $('#expedientes #caratula #numero-text').append ''
    $('#expedientes #caratula #iniciador-text').append '&nbsp;'
    $('#expedientes #caratula #asunto-text').append '&nbsp;'
    $('#expedientes #caratula').css('display','none')
    return

  ## hotkey create expedientes
  $.ctrl 'C', ->
    $('#expedientes #btn-new').click()
    return

  ## hotkey edit expedientes
  $.ctrl 'E', ->
    $('#expedientes table tbody').find('.info').find('.linktoedit').click()
    return

  $('#expediente-show #print-expediente').on 'click', ->
    $('#expediente-show').print
      globalStyles: true
      mediaPrint: false
      stylesheet: null
      noPrintSelector: '.no-print'
      iframe: true
      append: null
      manuallyCopyFormValues: true
      deferred: $.Deferred()
      timeout: 250

  ## hotkey print expediente
  $.ctrl 'P', ->
    $('#expediente-show #print-expediente').click()
    return
