"<% url_helpers = Rails.application.routes.url_helpers %>"

class Procedures {
  static indexDataTable() {
    $('#procedures-table').dataTable({
      processing: true,
      serverSide: true,
      // columns: [
      //   { name: 'attendance_type', orderable: true, searchable: false }
      //   { name: 'title', orderable: true, searchable: false }
      //   { name: 'abbreviation', orderable: true, searchable: false }
      //   { name: 'status', orderable: true, searchable: false }
      //   { name: 'default', orderable: true, searchable: false }
      // ]
      ajax: {
        url: $('#procedures-table').data('url'),
        method: 'GET',
        dataType: 'json'
        // Needed for the filters
        // data: function(params) {
        //   params.status_filter = $('select.status-filter').val()
        //   return params
      }
    })
  }

  static initiatorsSelect2() {
    let options = {
      multiple: true,
      placeholder: 'Busque personas y/o instituciones',
      theme: 'bootstrap',
      language: 'es',
      minimumInputLength: 2,
      ajax: {
        url: "<%= url_helpers.initiators_path(format: :json) %>",
        dataType: 'json',
        delay: 250,
        cache: true,
        data: (params) => {
          return {
            select_q: params.term
          };
        },
        processResults: (data, params) => {
          return { results: data }
        }
      }
    }
    $('#procedure_person_ids').select2(options)

    options.ajax.url = "<%= url_helpers.legislative_files_path  %>"
    options.placeholder = 'Busque expedientes ...'
    $('#legislative_file_ids').select2(options)

    options.ajax.url = "<%= url_helpers.initiators_path(only: :councilors, format: :json) %>"
    options.placeholder = 'Busque concejales por nombre y/o apellido ...'
    $('#councilor_ids').select2(options)

    options.ajax.url = "<%= url_helpers.initiators_path(only: :commissions, format: :json) %>"
    options.placeholder = 'Busque por nombre de comisiÃ³n ...'
    $('#comision_ids').select2(options)

    $('.finished').on('click', () => {
      if ($('.finished').attr('checked')) {
        $('.finished').attr('checked', false);
        $('.finished-field').css('display', 'none');
      }
      else {
        $('.finished').attr('checked', true);
        $('.finished-field').css('display', 'block');
      }
    })
    $('#procedure-new .initiator-btn').css('margin-left', '-28px');
  }
  static updateProcedureType() {
    $('.dispatch-procedure').hide()
    $(document).on('change', '#procedure_type', () => {
      if ($('#procedure_type').val() == 'Despacho') {
        $('.dispatch-procedure').show(1000)
        $('.common-procedure').hide(1000)
      }
      else {
        $('.dispatch-procedure').hide(1000)
        $('.common-procedure').show(1000)
      }
    })
  }
}

class ProcedureForm {
  constructor() {
    this.requestInProcess = false;
  }

  initiatorsModal() {
    $('#procedure-new').on('click', '.initiator-btn', (ev) => {
      if (!this.requestInProcess) {
        this.requestInProcess = true;
        $.get(
          $(ev.currentTarget).data('url'),
          (response) => {
            $('.initiators-modal').html(response);
            $('.initiators-modal .modal').modal('show');
            this.requestInProcess = false;
          }
        );
      }
    });
  }
}

$(document).on('ready', function() {
  if ($('#procedure-new').length) {
    let form = new ProcedureForm();
    form.initiatorsModal();
    $('#fecha_y_hora').datetimepicker({
      locale: 'es',
      format:'DD/MM/YYYY HH:mm'
    });
    Procedures.initiatorsSelect2();
    Procedures.updateProcedureType();
    $('.derivation').select2();

    $('.add_fields').on('click', function() {
      $('.derivation:last').select2();
    });

    $('#new_procedure').fileupload();
  }
})
